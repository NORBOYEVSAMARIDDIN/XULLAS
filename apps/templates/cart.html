{% extends "users/base.html" %}
{% load static %}

{% block title %}Product List{% endblock %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/base.css' %}">
<link rel="stylesheet" href="{% static 'css/components.css' %}">
<link rel="stylesheet" href="{% static 'css/products.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon@4.1.0/fonts/remixicon.css" rel="stylesheet">
<style>
    .catalog-wrapper {
        max-width: 1000px;
        margin: 60px auto;
        background: #ffffff;
        padding: 40px;
        border-radius: 16px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.06);
        display: flex;
        flex-direction: column;
        gap: 45px;
    }

    .header-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-direction: column;
    }

    .header-bar h2 {
        font-size: 24px;
        font-weight: 600;
    }

    .modern-table {
        width: 100%;
        border-collapse: collapse;
        border-radius: 10px;
        overflow: hidden;
    }

    .modern-table td,
    .modern-table th {
        text-align: left;
        padding: 16px;
        font-size: 15px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        vertical-align: middle;
        max-width: 200px;
    }

    .modern-table td img {
        display: block;
        max-width: 80px;
        max-height: 60px;
        object-fit: cover;
        border-radius: 6px;
    }

    .modern-table thead {
        background-color: #f1f5f9;
    }

    .modern-table tbody tr:nth-child(even) {
        background-color: #f8fafc;
    }

    .modern-table tbody tr:hover {
        background-color: #eef2f7;
    }

    .action-icons {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .action-icons a,
    .action-icons p {
        color: var(--muted);
        font-size: 18px;
        transition: 0.2s ease;
        margin: 0;
    }

    .action-icons a:hover,
    .action-icons p:hover {
        transform: scale(1.2);
        color: var(--primary);
    }

    .alert-custom {
        max-width: 1000px;
        margin: 0 auto 20px;
    }

    .cursor-pointer {
        cursor: default;
    }

    #map {
        width: 100%;
    }

    .form-button {
        width: 100%;
        display: flex;
        justify-content: center;
    }

    .confirm_overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        width: 100vw;
        background: rgba(0, 0, 0, 0.6);
        z-index: 998;
    }

    .confirm_form {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        z-index: 999;
        max-width: 600px;
        width: 90%;
    }

    .alert-error {
        background-color: var(--secondary);
        color: white;
    }

    /* ðŸ“± Mobile Responsive Enhancements */
    @media (max-width: 768px) {
        .catalog-wrapper {
            padding: 20px;
            margin: 20px 10px;
        }

        .header-bar {
            gap: 10px;
            text-align: center;
        }

        .modern-table thead {
            display: none;
        }

        .modern-table,
        .modern-table tbody,
        .modern-table tr,
        .modern-table td {
            display: block;
            width: 100%;
        }

        .modern-table tr {
            background: #f9fafb;
            margin-bottom: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 10px;
        }

        .modern-table td {
            display: flex;
            justify-content: space-between;
            padding: 10px 14px;
            border-bottom: 1px solid #e2e8f0;
        }

        .modern-table td:last-child {
            border-bottom: none;
        }

        .modern-table td::before {
            content: attr(data-label);
            font-weight: 600;
            color: #64748b;
            margin-right: 12px;
        }

        .modern-table td img {
            max-width: 100px;
            max-height: 80px;
        }

        .action-icons {
            justify-content: flex-end;
        }

        .confirm_form {
            padding: 20px;
        }

        .select-address > h4 {
            font-size: 18px;
        }

        .address_display {
            font-size: 14px;
        }

        #map {
            height: 300px;
        }

        .form-button {
            flex-direction: column;
            gap: 10px;
        }

        .btn {
            width: 100%;
        }

        .table th,
        .table td {
            font-size: 14px;
            padding: 6px;
        }
    }
</style>
{% endblock %}

{% block content %}
{% include 'partials/header.html' %}

{% if messages %}
<div class="container mt-3">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show d-flex align-items-center gap-2 shadow-sm auto-dismiss" role="alert">
        {% if message.tags == "success" %}
        <i class="ri-checkbox-circle-line text-success fs-5"></i>
        {% elif message.tags == "error" %}
        <i class="ri-close-circle-line text-white fs-5"></i>
        {% elif message.tags == "warning" %}
        <i class="ri-error-warning-line text-warning fs-5"></i>
        {% elif message.tags == "info" %}
        <i class="ri-information-line text-info fs-5"></i>
        {% else %}
        <i class="ri-information-line text-muted fs-5"></i>
        {% endif %}
        <div>{{ message }}</div>
        <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="catalog-wrapper">
    <div class="header-bar">
        <h2><i class="ri-shopping-cart-line" style="margin-right: 8px;"></i>Cart</h2>
        <div class="table-responsive">
            <table class="modern-table table">
                <thead>
                    {% if products %}
                    <tr>
                        <th>ID</th>
                        <th>Photo</th>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Catalog</th>
                        <th>Price</th>
                        <th style="width: 120px;">Actions</th>
                        <th>Total</th>
                    </tr>
                    {% endif %}
                </thead>
                <tbody>
                    {% for product in products %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>
                            {% if product.photo %}
                            <img src="{{ product.photo.url }}" alt="{{ product.name }}">
                            {% else %}
                            <span>No photo</span>
                            {% endif %}
                        </td>
                        <td>{{ product.name }}</td>
                        <td>{{ product.description }}</td>
                        <td>{{ product.catalog }}</td>
                        <td>{{ product.price }}</td>
                        <td>
                            <div class="action-icons cursor-pointer">
                                <a href="{% url 'cart:substract' product.id %}" title="View">
                                    <i class="ri-subtract-line"></i>
                                </a>
                                <p>{{ product.cartitem_count }}</p>
                                <a href="{% url 'cart:add' product.id %}" title="Delete">
                                    <i class="ri-add-line"></i>
                                </a>
                            </div>
                        </td>
                        <td>
                            <div class="action-icons cursor-pointer">
                                <p>{{ product.total_price }}</p>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3">No products yet.</td>
                    </tr>
                    {% endfor %}
                    {% if products %}
                    <tr>
                        <td colspan="6"></td>
                        <td>
                            <div class="action-icons cursor-pointer">
                                <p>Total: {{ total_products }}</p>
                            </div>
                        </td>
                        <td>
                            <div class="action-icons cursor-pointer">
                                <p>{{ total }}</p>
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <div class='select-address mt-4'>
        <h4 class="text-center"><b>Choose delivery address here</b></h4>
        <input type="hidden" name="latitude" id="id_lat">
        <input type="hidden" name="longitude" id="id_lng">
        <input type="hidden" name="address" id="id_address">
        <p><b>Selected address:</b> <span class="address_display">Detecting...</span></p>
        <div id="map" style="height: 400px;"></div>
        <br>
        <button type='button' class="btn btn-secondary" onclick="setDefaultLocation()">Choose Default Location</button>
        <div class="mt-3">
            <button type='button' class="btn btn-success" onclick="showConfirm()">Order</button>
        </div>
    </div>
</div>

<div style="display: none;">
    {% if address %}
    <div id="address">{{ address.address }}</div>
    <div id="longitude">{{ address.longitude }}</div>
    <div id="latitude">{{ address.latitude }}</div>
    {% else %}
    <div id="address">Charing Cross, London WC2N 5DU, United Kingdom</div>
    <div id="longitude">-0.1278</div>
    <div id="latitude">51.5074</div>
    {% endif %}
</div>

<div id="confirm_overlay" class='confirm_overlay' onclick='closeConfirm()'></div>
<div id="confirm_form" class='confirm_form'>
    <h4 class="mb-4">Confirm Your Order</h4>
    <form method="post">
        {% csrf_token %}
        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Count</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                {% for product in products %}
                <tr>
                    <td>{{ product.name }}</td>
                    <td>{{ product.cartitem_count }}</td>
                    <td>{{ product.total_price }}</td>
                </tr>
                {% endfor %}
                <tr>
                    <td>Address:</td>
                    <td colspan="2"><span class="address_display">Detecting...</span></td>
                </tr>
                <tr>
                    <td><b>Total:</b></td>
                    <td>{{ total_products }}</td>
                    <td>{{ total }}</td>
                </tr>
            </tbody>
        </table>
        <input type="hidden" name="latitude" id="latitude_confirm">
        <input type="hidden" name="longitude" id="longitude_confirm">
        <input type="hidden" name="address" id="address_confirm">
        <div class="d-flex flex-column flex-sm-row justify-content-between gap-3 mt-3">
            <button type="button" class="btn btn-secondary" onclick="closeConfirm()">Cancel</button>
            <input type="submit" class="btn btn-success" value="Confirm">
        </div>
    </form>
</div>

<script>
    let map;
    let marker;
    let geocoder;

    function showConfirm() {
        const latitude = document.getElementById("id_lat").value;
        const longitude = document.getElementById("id_lng").value;
        const address = document.getElementById("id_address").value;
        document.getElementById("latitude_confirm").value = latitude;
        document.getElementById("longitude_confirm").value = longitude;
        document.getElementById("address_confirm").value = address;

        document.getElementById("confirm_overlay").style.display = "block";
        document.getElementById("confirm_form").style.display = "block";
        document.body.style.overflow = "hidden";
    }

    function closeConfirm() {
        document.getElementById("confirm_overlay").style.display = "none";
        document.getElementById("confirm_form").style.display = "none";
        document.body.style.overflow = "";
    }

    function initMap() {
        const defaultLat = 51.5074;
        const defaultLng = -0.1278;

        let latText = document.getElementById("latitude")?.innerText;
        let lngText = document.getElementById("longitude")?.innerText;

        const initialLat = parseFloat(latText) || defaultLat;
        const initialLng = parseFloat(lngText) || defaultLng;
        const initialPosition = { lat: initialLat, lng: initialLng };

        geocoder = new google.maps.Geocoder();

        map = new google.maps.Map(document.getElementById("map"), {
            center: initialPosition,
            zoom: 10,
        });

        marker = new google.maps.Marker({
            position: initialPosition,
            map: map,
            draggable: true,
        });

        updateLocation(initialPosition.lat, initialPosition.lng);

        map.addListener("click", (e) => {
            const lat = e.latLng.lat();
            const lng = e.latLng.lng();
            marker.setPosition(e.latLng);
            updateLocation(lat, lng);
        });

        marker.addListener("dragend", () => {
            const pos = marker.getPosition();
            updateLocation(pos.lat(), pos.lng());
        });
    }

    function updateLocation(lat, lng) {
        document.getElementById("id_lat").value = lat;
        document.getElementById("id_lng").value = lng;

        geocoder.geocode({ location: { lat: lat, lng: lng } }, (results, status) => {
            if (status === "OK" && results[0]) {
                const address = results[0].formatted_address;
                document.getElementById("id_address").value = address;
                document.querySelectorAll(".address_display").forEach(el => {
                    el.innerText = address;
                });
            } else {
                document.getElementById("id_address").value = "";
                document.querySelectorAll(".address_display").forEach(el => {
                    el.innerText = address;
                });
            }
        });
    }

    function setDefaultLocation() {
        let latText = document.getElementById("latitude")?.innerText;
        let lngText = document.getElementById("longitude")?.innerText;

        const initialLat = parseFloat(latText) || defaultLat;
        const initialLng = parseFloat(lngText) || defaultLng;
        const defaultLocation = { lat: initialLat, lng: initialLng };

        marker.setPosition(defaultLocation);
        map.setCenter(defaultLocation);
        updateLocation(defaultLocation.lat, defaultLocation.lng);
    }
</script>

<script async defer
    src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap&language=en">
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const alerts = document.querySelectorAll(".auto-dismiss");
        alerts.forEach((alert) => {
            setTimeout(() => {
                const bsAlert = bootstrap.Alert.getOrCreateInstance(alert);
                bsAlert.close();
            }, 2000);
        });
    });
</script>
{% endblock %}
